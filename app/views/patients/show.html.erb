<% content_for :assets do %>
  <%= javascript_pack_tag "datatables" %>
  <%= javascript_pack_tag "moment" %>
  <%= javascript_pack_tag "patients_show_datatable" %>
<% end %>
<%= render partial: "layouts/breadcrumb", locals: { jurisdiction_path: @current_user_jurisdiction, crumbs: [ {value: "Return to Exposure Dashboard", href: '/'}, {value: "Monitoree Details", href: nil} ], isolation: @patient&.isolation || false } %>

<% if @able_to_perform_action %>
  <%= react_component("subject/DownloadMonitoreeExcel", { authenticity_token: form_authenticity_token, patient: @patient_hash} ) %>
<% end %>

<%= react_component("patient/PatientPage", { patient: @patient_hash, group_members: @group_members, patient_id: @patient.user_defined_id_statelocal || '', dashboardUrl: '/public_health', authenticity_token: form_authenticity_token, hideBody: @able_to_perform_action, jurisdictionPath: @jurisdiction_path }) %>

<% if @able_to_perform_action %>
  <div class="card mx-2 mt-4 mb-4 card-square">
    <h5 class="card-header">Monitoring Actions</h5>
    <%= react_component("subject/MonitoringStatus", {
        current_user_jurisdiction_path: @current_user_jurisdiction,
        authenticity_token: form_authenticity_token,
        has_group_members: @group_members.nil? || @group_members.size > 1,
        in_a_group: @all_group_members.size > 1,
        patient: @patient_hash,
        jurisdictionPaths: @jurisdiction_paths,
        assignedUsers: @assigned_users,
        isolation: @patient.isolation
        }) %>
  </div>
<% end %>

<% if @able_to_perform_action %>
  <div class="modal fade" tabindex="-1" role="dialog" id="modal-new">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <%= react_component("assessment/Assessment", { signed_in: current_user.nil?, assessment: {}, threshold_hash: @threshold_hash, symptoms: @symptoms, idPre: 'new', patient_submission_token: @patient.submission_token, authenticity_token: form_authenticity_token, reload: true, patient_id: @patient.id, translations: @translations, lang: 'en' }) %>
        </div>
      </div>
    </div>
  </div>
  <div class="card mx-2 mt-3 mb-4 card-square">
    <h5 class="card-header"> Reports</h5>
    <div class="m-4">
      <%= react_component("subject/CurrentStatus", { report_eligibility: @patient.report_eligibility, status: @patient.status, isolation: @patient.isolation } ) %>
      <div class="pb-4 pt-2">
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-primary mr-2" data-toggle="modal" data-target="#modal-new"><i class="fas fa-plus"></i> Add New Report</button>
          <% unless @patient.isolation %>
            <%= react_component("subject/ClearReports", { authenticity_token: form_authenticity_token, patient: @patient_hash } ) %>
          <% end %>
          <% if @patient.monitoring %>
            <%= react_component("subject/PauseNotifications", { authenticity_token: form_authenticity_token, patient: @patient_hash } ) %>
          <% end %>
          <%= react_component("subject/ContactAttempt", { authenticity_token: form_authenticity_token, patient: @patient_hash } ) %>
        </div>
      </div>
      <table class="assessment_table table table-sm table-striped table-bordered table-hover table-smaller-font" style="width:100%">
        <thead>
          <tr>
            <th class="DataTable-table-header">ID</th>
            <% unless @patient.isolation %>
              <th class="DataTable-table-header dt-a-w-50">
                Needs Review <%= react_component("util/InfoTooltip", { tooltipTextKey: 'exposureNeedsReviewColumn', location: 'right' }, { style: 'display:inline' }) %>
              </th>
            <% end %>
            <th class="DataTable-table-header">
              Reporter
            </th>
            <th class="DataTable-table-header">
              Created
            </th>
            <% @symptom_names.each do |symptom| -%>
              <th class="DataTable-table-header dt-a-w-75">
                <%= symptom&.titleize %>
              </th>
            <% end -%>
            <th class="DataTable-table-header">
              Actions
            </th>
          </tr>
        </thead>
        <tbody>
        <% @assessments.each do |assessment| -%>
          <tr class="<% if assessment.symptomatic %>table-danger<% end %>">
            <td>
              <%= assessment.id %>
            </td>
            <% unless @patient.isolation %>
              <td>
                <% if assessment.symptomatic %>
                  Yes
                <% else %>
                  No
                <% end %>
              </td>
            <% end %>
            <td>
              <%= assessment.who_reported %>
            </td>
            <td>
              <%= local_time(assessment.created_at, '%Y-%m-%d %H:%M %Z') %>
            </td>
            <% @columns.keys.each do |symptom| -%>
              <% if @columns[symptom][:reported_symptom] == nil %>
                <td></td>
              <% end %>
              <% if @columns[symptom][:reported_symptom]&.type == "BoolSymptom"%>
                <% if @columns[symptom][:reported_value] %>
                  <% symptom_value = "Yes" %>
                <% else %>
                  <% symptom_value = "No"%>
                <%end%>
                <td>
                  <% if @columns[symptom][:passes_threshold] -%>
                    <span class="concern"><%=symptom_value%></span>
                  <% else -%>
                    <%=symptom_value%>
                  <% end -%>
                </td>
              <% end %>
              <% if @columns[symptom][:reported_symptom]&.type == "FloatSymptom" || @columns[symptom][:reported_symptom]&.type == "IntegerSymptom"%>
                <td>
                  <% if @columns[symptom][:passes_threshold] -%>
                    <span class="concern"><%=symptom_value%></span>
                  <% else -%>
                    <%=symptom_value%>
                  <% end -%>
                </td>
              <% end %>
            <% end -%>
            <td>
              <div class="dropdown">
                <button class="btn btn-sm btn-outline-primary dropdown-toggle btn-block a-dropdown" type="button" id="actionsButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="fas fa-cogs fw"></i>
                </button>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="actionsButton">
                  <button type="button" data-toggle="modal" data-target="#modal-<%= assessment.id %>" class="dropdown-item"><i class="fas fa-edit fa-fw"></i> Edit</button>
                  <%= react_component("subject/AddReportNote", { assessment: assessment, patient: @patient_hash, authenticity_token: form_authenticity_token }) %>
                  <% unless @patient.isolation %>
                    <%= react_component("subject/ClearSingleReport", { assessment_id: assessment.id, patient: @patient_hash, authenticity_token: form_authenticity_token }) %>
                  <% end %>
                </div>
              </div>
            </td>
          </tr>
        <% end -%>
      </tbody>
    </table>
    <%= react_component("subject/LastDateExposure", { authenticity_token: form_authenticity_token, patient: @patient_hash, has_group_members: @all_group_members.size > 1 } ) %>
    </div>
  </div>

  <% @assessments.each do |assessment| -%>
    <div class="modal fade" tabindex="-1" role="dialog" id="<%= 'modal-' + assessment.id.to_s %>" key="<%= 'modal-' + assessment.id.to_s %>">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <%= react_component("assessment/Assessment", { signed_in: current_user.nil?, assessment: assessment, threshold_hash: assessment&.reported_condition&.threshold_condition_hash, symptoms: assessment&.reported_condition&.symptoms, idPre: assessment.id.to_s, updateId: assessment.id, patient_submission_token: @patient.submission_token, authenticity_token: form_authenticity_token, reload: true, patient_id: @patient.id, translations: assessment.translations, lang: 'en' }) %>
          </div>
        </div>
      </div>
    </div>
  <% end -%>
<% end %>

<% if @able_to_perform_action %>
  <div class="card mx-2 mt-3 mb-4 card-square">
    <h5 class="card-header">
      Lab Results
      <%= react_component("util/InfoTooltip", { tooltipTextKey: 'labResults', location: 'right' }, { style: 'display:inline' }) %>
    </h5>
    <div class="m-4">
      <table class="lab_table table table-sm table-striped table-bordered table-hover table-smaller-font" style="width:100%">
        <thead>
          <tr>
            <th class="DataTable-table-header">ID</th>
            <th class="DataTable-table-header">Type</th>
            <th class="DataTable-table-header">Specimen Collected</th>
            <th class="DataTable-table-header">Report</th>
            <th class="DataTable-table-header">Result</th>
            <th class="DataTable-table-header">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @laboratories.each do |lab| -%>
            <tr>
              <td><%= lab.id %></td>
              <td><%= lab.lab_type %></td>
              <td><%= lab.specimen_collection %></td>
              <td><%= lab.report %></td>
              <td><%= lab.result %></td>
              <td>
                <div class="btn-group btn-group-sm" role="group">
                  <%= react_component("laboratory/Laboratory", { authenticity_token: form_authenticity_token, patient: @patient_hash, lab: lab } ) %>
                </div>
              </td>
            </tr>
          <% end -%>
        </tbody>
      </table>
      <div class="pb-1">
        <div class="btn-group" role="group">
          <%= react_component("laboratory/Laboratory", { authenticity_token: form_authenticity_token, patient: @patient_hash, lab: Laboratory.new } ) %>
        </div>
      </div>
    </div>
  </div>
<% end %>

<% if @able_to_perform_action %>
  <div class="card mx-2 mt-3 mb-4 card-square">
    <h5 class="card-header">
      Close Contacts
      <%= react_component("util/InfoTooltip", { tooltipTextKey: 'closeContacts', location: 'right' }, { style: 'display:inline' }) %>
    </h5>
    <div class="m-4">
      <table class="cc_table table table-sm table-striped table-bordered table-hover table-smaller-font" style="width:100%">
        <thead>
          <tr>
            <th class="DataTable-table-header">First Name</th>
            <th class="DataTable-table-header">Last Name</th>
            <th class="DataTable-table-header">Phone Number</th>
            <th class="DataTable-table-header">Email</th>
            <th class="DataTable-table-header">Contact Attempts</th>
            <th class="DataTable-table-header">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @close_contacts.each do |cc| -%>
            <tr>
              <td><%= cc.first_name %></td>
              <td><%= cc.last_name %></td>
              <td><%= cc.primary_telephone %></td>
              <td><%= cc.email %></td>
              <td><%= cc.contact_attempts %></td>
              <td>
                <div class="btn-group btn-group-sm" role="group">
                  <%= react_component("close_contact/CloseContact", { authenticity_token: form_authenticity_token, patient: @patient_hash, close_contact: cc, user_role: @current_user_role } ) %>
                </div>
              </td>
            </tr>
          <% end -%>
        </tbody>
      </table>
      <div class="pb-1">
        <div class="btn-group" role="group">
          <%= react_component("close_contact/CloseContact", { authenticity_token: form_authenticity_token, patient: @patient_hash, close_contact: CloseContact.new, user_role: @current_user_role } ) %>
        </div>
      </div>
    </div>
  </div>
<% end %>

<% if @able_to_perform_action %>
  <%= react_component("history/HistoryComponent", { patient_id: @patient.id, histories: @histories, authenticity_token: form_authenticity_token } ) %>
<% end %>

<script>
$(document).ready(function() {
  $('.assessment_table').DataTable({
    "search": false,
    "info": false,
    "lengthMenu": [10, 15, 25, 50],
    "pageLength": 15,
    "columnDefs": [{
      "orderable": false,
      "targets": -1
    }],
    "oLanguage": {
      "sSearch": "Search Reports:"
    },
    "order": [
      [0, "desc"]
    ],
    "dom": "<'row'<'col-sm-24 col-md-12'l><'col-sm-24 col-md-12'f>>" + "<'row'<'col-sm-24'tr>>" + "<'row'<'col-sm-24 col-md-10'i><'col-sm-24 col-md-14'p>>"
  });
  $('.lab_table').DataTable({
    "search": false,
    "info": false,
    "lengthMenu": [10, 15, 25, 50],
    "pageLength": 15,
    "oLanguage": {
      "sSearch": "Search Lab Results:"
    },
    "dom": "<'row'<'col-sm-24 col-md-12'l><'col-sm-24 col-md-12'f>>" + "<'row'<'col-sm-24'tr>>" + "<'row'<'col-sm-24 col-md-10'i><'col-sm-24 col-md-14'p>>"
  });
  $('.cc_table').DataTable({
    "search": false,
    "info": false,
    "lengthMenu": [10, 15, 25, 50],
    "pageLength": 15,
    "oLanguage": {
      "sSearch": "Search Close Contacts:"
    },
    "dom": "<'row'<'col-sm-24 col-md-12'l><'col-sm-24 col-md-12'f>>" + "<'row'<'col-sm-24'tr>>" + "<'row'<'col-sm-24 col-md-10'i><'col-sm-24 col-md-14'p>>"
  });
});
</script>
